{"ast":null,"code":"import webSocketService from './websocket';\nclass LocationService {\n  constructor() {\n    this.watchId = null;\n    this.isTracking = false;\n    this.listeners = {\n      update: [],\n      error: []\n    };\n    this.options = {\n      enableHighAccuracy: true,\n      maximumAge: 5000,\n      timeout: 10000\n    };\n    this.lastPosition = null;\n    this.minUpdateInterval = 2000; // Minimum time between updates in ms\n    this.lastUpdateTime = 0;\n    this.errorCount = 0;\n    this.maxErrorCount = 3;\n  }\n  startTracking() {\n    if (!navigator.geolocation) {\n      this.notifyListeners('error', new Error('Geolocation is not supported by your browser'));\n      return false;\n    }\n    if (this.isTracking) {\n      return true;\n    }\n    try {\n      // Reset error count\n      this.errorCount = 0;\n\n      // First try to get current position immediately\n      navigator.geolocation.getCurrentPosition(position => {\n        console.log(\"Initial position obtained:\", position);\n        this.handlePositionUpdate(position);\n\n        // Then start watching for position updates\n        this.watchId = navigator.geolocation.watchPosition(this.handlePositionUpdate.bind(this), this.handlePositionError.bind(this), this.options);\n      }, error => {\n        console.error(\"Error getting initial position:\", error);\n        this.handlePositionError(error);\n\n        // Still try to watch position even if initial position fails\n        this.watchId = navigator.geolocation.watchPosition(this.handlePositionUpdate.bind(this), this.handlePositionError.bind(this), this.options);\n      }, this.options);\n      this.isTracking = true;\n      return true;\n    } catch (error) {\n      console.error(\"Error in startTracking:\", error);\n      this.notifyListeners('error', error);\n      return false;\n    }\n  }\n  stopTracking() {\n    if (this.watchId !== null) {\n      navigator.geolocation.clearWatch(this.watchId);\n      this.watchId = null;\n      this.isTracking = false;\n    }\n  }\n  handlePositionUpdate(position) {\n    console.log(\"Position update received:\", position);\n    const now = Date.now();\n\n    // Throttle updates to prevent too frequent position changes\n    if (now - this.lastUpdateTime < this.minUpdateInterval) {\n      console.log(\"Update throttled (too frequent)\");\n      return;\n    }\n\n    // Check if position has changed significantly\n    if (this.lastPosition) {\n      const prevLat = this.lastPosition.coords.latitude;\n      const prevLng = this.lastPosition.coords.longitude;\n      const newLat = position.coords.latitude;\n      const newLng = position.coords.longitude;\n\n      // Calculate distance (very rough approximation)\n      const distance = Math.sqrt(Math.pow(newLat - prevLat, 2) + Math.pow(newLng - prevLng, 2));\n\n      // If position hasn't changed much, don't update\n      if (distance < 0.00001) {\n        // Very small threshold\n        console.log(\"Update throttled (position hasn't changed)\");\n        return;\n      }\n    }\n    this.lastPosition = position;\n    this.lastUpdateTime = now;\n    const coordinates = {\n      latitude: position.coords.latitude,\n      longitude: position.coords.longitude,\n      accuracy: position.coords.accuracy,\n      timestamp: position.timestamp\n    };\n    console.log(\"Sending coordinates to listeners:\", coordinates);\n\n    // Reset error count on successful update\n    this.errorCount = 0;\n\n    // Notify local listeners\n    this.notifyListeners('update', coordinates);\n\n    // Send to server via WebSocket\n    webSocketService.sendMessage({\n      type: 'locationUpdate',\n      coordinates\n    });\n  }\n  handlePositionError(error) {\n    console.error(\"Position error:\", error);\n    this.errorCount++;\n\n    // If we've had too many errors, stop tracking\n    if (this.errorCount >= this.maxErrorCount) {\n      console.log(\"Too many errors, stopping tracking\");\n      this.stopTracking();\n    }\n    let errorMessage;\n    switch (error.code) {\n      case error.PERMISSION_DENIED:\n        errorMessage = 'Location access denied. Please enable location services in your browser settings.';\n        break;\n      case error.POSITION_UNAVAILABLE:\n        errorMessage = 'Location information is unavailable. Please check your device GPS or try again later.';\n        break;\n      case error.TIMEOUT:\n        errorMessage = 'Location request timed out. Please check your internet connection.';\n        break;\n      default:\n        errorMessage = 'An unknown error occurred while getting location.';\n    }\n    const errorObj = new Error(errorMessage);\n    errorObj.originalError = error;\n    this.notifyListeners('error', errorObj);\n  }\n  addListener(event, callback) {\n    if (this.listeners[event]) {\n      this.listeners[event].push(callback);\n    }\n  }\n  removeListener(event, callback) {\n    if (this.listeners[event]) {\n      this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);\n    }\n  }\n  removeAllListeners() {\n    this.listeners = {\n      update: [],\n      error: []\n    };\n  }\n  notifyListeners(event, data) {\n    if (this.listeners[event]) {\n      this.listeners[event].forEach(callback => {\n        try {\n          callback(data);\n        } catch (error) {\n          console.error(`Error in ${event} listener:`, error);\n        }\n      });\n    }\n  }\n}\nconst locationService = new LocationService();\nexport default locationService;","map":{"version":3,"names":["webSocketService","LocationService","constructor","watchId","isTracking","listeners","update","error","options","enableHighAccuracy","maximumAge","timeout","lastPosition","minUpdateInterval","lastUpdateTime","errorCount","maxErrorCount","startTracking","navigator","geolocation","notifyListeners","Error","getCurrentPosition","position","console","log","handlePositionUpdate","watchPosition","bind","handlePositionError","stopTracking","clearWatch","now","Date","prevLat","coords","latitude","prevLng","longitude","newLat","newLng","distance","Math","sqrt","pow","coordinates","accuracy","timestamp","sendMessage","type","errorMessage","code","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","errorObj","originalError","addListener","event","callback","push","removeListener","filter","cb","removeAllListeners","data","forEach","locationService"],"sources":["C:/Programming/Clubs/CIS/HackPrix/drift-guard-1pm/client/src/utils/locationService.js"],"sourcesContent":["import webSocketService from './websocket';\n\nclass LocationService {\n  constructor() {\n    this.watchId = null;\n    this.isTracking = false;\n    this.listeners = {\n      update: [],\n      error: []\n    };\n    this.options = {\n      enableHighAccuracy: true,\n      maximumAge: 5000,\n      timeout: 10000\n    };\n    this.lastPosition = null;\n    this.minUpdateInterval = 2000; // Minimum time between updates in ms\n    this.lastUpdateTime = 0;\n    this.errorCount = 0;\n    this.maxErrorCount = 3;\n  }\n\n  startTracking() {\n    if (!navigator.geolocation) {\n      this.notifyListeners('error', new Error('Geolocation is not supported by your browser'));\n      return false;\n    }\n    \n    if (this.isTracking) {\n      return true;\n    }\n    \n    try {\n      // Reset error count\n      this.errorCount = 0;\n      \n      // First try to get current position immediately\n      navigator.geolocation.getCurrentPosition(\n        (position) => {\n          console.log(\"Initial position obtained:\", position);\n          this.handlePositionUpdate(position);\n          \n          // Then start watching for position updates\n          this.watchId = navigator.geolocation.watchPosition(\n            this.handlePositionUpdate.bind(this),\n            this.handlePositionError.bind(this),\n            this.options\n          );\n        },\n        (error) => {\n          console.error(\"Error getting initial position:\", error);\n          this.handlePositionError(error);\n          \n          // Still try to watch position even if initial position fails\n          this.watchId = navigator.geolocation.watchPosition(\n            this.handlePositionUpdate.bind(this),\n            this.handlePositionError.bind(this),\n            this.options\n          );\n        },\n        this.options\n      );\n      \n      this.isTracking = true;\n      return true;\n    } catch (error) {\n      console.error(\"Error in startTracking:\", error);\n      this.notifyListeners('error', error);\n      return false;\n    }\n  }\n\n  stopTracking() {\n    if (this.watchId !== null) {\n      navigator.geolocation.clearWatch(this.watchId);\n      this.watchId = null;\n      this.isTracking = false;\n    }\n  }\n\n  handlePositionUpdate(position) {\n    console.log(\"Position update received:\", position);\n    const now = Date.now();\n    \n    // Throttle updates to prevent too frequent position changes\n    if (now - this.lastUpdateTime < this.minUpdateInterval) {\n      console.log(\"Update throttled (too frequent)\");\n      return;\n    }\n    \n    // Check if position has changed significantly\n    if (this.lastPosition) {\n      const prevLat = this.lastPosition.coords.latitude;\n      const prevLng = this.lastPosition.coords.longitude;\n      const newLat = position.coords.latitude;\n      const newLng = position.coords.longitude;\n      \n      // Calculate distance (very rough approximation)\n      const distance = Math.sqrt(\n        Math.pow(newLat - prevLat, 2) + \n        Math.pow(newLng - prevLng, 2)\n      );\n      \n      // If position hasn't changed much, don't update\n      if (distance < 0.00001) { // Very small threshold\n        console.log(\"Update throttled (position hasn't changed)\");\n        return;\n      }\n    }\n    \n    this.lastPosition = position;\n    this.lastUpdateTime = now;\n    \n    const coordinates = {\n      latitude: position.coords.latitude,\n      longitude: position.coords.longitude,\n      accuracy: position.coords.accuracy,\n      timestamp: position.timestamp\n    };\n    \n    console.log(\"Sending coordinates to listeners:\", coordinates);\n    \n    // Reset error count on successful update\n    this.errorCount = 0;\n    \n    // Notify local listeners\n    this.notifyListeners('update', coordinates);\n    \n    // Send to server via WebSocket\n    webSocketService.sendMessage({\n      type: 'locationUpdate',\n      coordinates\n    });\n  }\n\n  handlePositionError(error) {\n    console.error(\"Position error:\", error);\n    this.errorCount++;\n    \n    // If we've had too many errors, stop tracking\n    if (this.errorCount >= this.maxErrorCount) {\n      console.log(\"Too many errors, stopping tracking\");\n      this.stopTracking();\n    }\n    \n    let errorMessage;\n    \n    switch (error.code) {\n      case error.PERMISSION_DENIED:\n        errorMessage = 'Location access denied. Please enable location services in your browser settings.';\n        break;\n      case error.POSITION_UNAVAILABLE:\n        errorMessage = 'Location information is unavailable. Please check your device GPS or try again later.';\n        break;\n      case error.TIMEOUT:\n        errorMessage = 'Location request timed out. Please check your internet connection.';\n        break;\n      default:\n        errorMessage = 'An unknown error occurred while getting location.';\n    }\n    \n    const errorObj = new Error(errorMessage);\n    errorObj.originalError = error;\n    \n    this.notifyListeners('error', errorObj);\n  }\n\n  addListener(event, callback) {\n    if (this.listeners[event]) {\n      this.listeners[event].push(callback);\n    }\n  }\n\n  removeListener(event, callback) {\n    if (this.listeners[event]) {\n      this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);\n    }\n  }\n  \n  removeAllListeners() {\n    this.listeners = {\n      update: [],\n      error: []\n    };\n  }\n\n  notifyListeners(event, data) {\n    if (this.listeners[event]) {\n      this.listeners[event].forEach(callback => {\n        try {\n          callback(data);\n        } catch (error) {\n          console.error(`Error in ${event} listener:`, error);\n        }\n      });\n    }\n  }\n}\n\nconst locationService = new LocationService();\nexport default locationService;\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}